<!DOCTYPE HTML>
<html lang="zh-CN" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>13.1 Cè¯­è¨€è¿è¡Œåº“ - ç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="custom.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>â†</kbd> or <kbd>â†’</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">ç¨‹åºå‘˜çš„è‡ªæˆ‘ä¿®å…»</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h2 id="131-cè¯­è¨€è¿è¡Œåº“"><a class="header" href="#131-cè¯­è¨€è¿è¡Œåº“">13.1 Cè¯­è¨€è¿è¡Œåº“</a></h2>
<p>åœ¨å¼€å§‹å®ç°Mini
CRTä¹‹å‰ï¼Œé¦–å…ˆè¦å¯¹å®ƒè¿›è¡ŒåŸºæœ¬çš„è§„åˆ’ã€‚"éº»é›€è™½å°äº”è„ä¿±å…¨"ï¼Œè™½ç„¶Mini
CRTå¾ˆå°ï¼Œä½†å®ƒåº”è¯¥å…·å¤‡CRTçš„åŸºæœ¬åŠŸèƒ½ä»¥åŠéµå¾ªå‡ ä¸ªåŸºæœ¬è®¾è®¡åŸåˆ™ï¼Œè¿™äº›æˆ‘ä»¬å½’ç»“ä¸ºå¦‚ä¸‹å‡ ä¸ªæ–¹é¢ï¼š</p>
<ul>
<li>é¦–å…ˆMini CRTåº”è¯¥ä»¥ANIS Cçš„æ ‡å‡†åº“ä¸ºç›®æ ‡ï¼Œå°½é‡åšåˆ°ä¸å…¶æ¥å£ç›¸ä¸€è‡´ã€‚</li>
<li>å…·æœ‰è‡ªå·±çš„å…¥å£å‡½æ•°ï¼ˆmini_crt_entryï¼‰ã€‚</li>
<li>åŸºæœ¬çš„è¿›ç¨‹ç›¸å…³æ“ä½œï¼ˆexitï¼‰ã€‚</li>
<li>æ”¯æŒå †æ“ä½œï¼ˆmallocã€freeï¼‰ã€‚</li>
<li>æ”¯æŒåŸºæœ¬çš„æ–‡ä»¶æ“ä½œï¼ˆfopenã€freadã€fwriteã€fcloseã€fseekï¼‰ã€‚</li>
<li>æ”¯æŒåŸºæœ¬çš„å­—ç¬¦ä¸²æ“ä½œï¼ˆstrcpyã€strlenã€strcmpï¼‰ã€‚</li>
<li>æ”¯æŒæ ¼å¼åŒ–å­—ç¬¦ä¸²å’Œè¾“å‡ºæ“ä½œï¼ˆprintfã€sprintfï¼‰ã€‚</li>
<li>æ”¯æŒatexit()å‡½æ•°ã€‚</li>
<li>æœ€åï¼ŒMini CRTåº”è¯¥æ˜¯è·¨å¹³å°çš„ã€‚æˆ‘ä»¬è®¡åˆ’è®©Mini
CRTèƒ½å¤ŸåŒæ—¶æ”¯æŒWindowså’ŒLinuxä¸¤ä¸ªæ“ä½œç³»ç»Ÿã€‚</li>
<li>Mini
CRTçš„å®ç°åº”è¯¥å°½é‡ç®€å•ï¼Œä»¥å±•ç¤ºCRTçš„å®ç°ä¸ºç›®çš„ï¼Œå¹¶ä¸è¿½æ±‚åŠŸèƒ½å’Œæ€§èƒ½ï¼ŒåŸºæœ¬ä¸Šæ˜¯"ç‚¹åˆ°ä¸ºæ­¢"</li>
</ul>
<p>ä¸ºäº†ä½¿CRTèƒ½å¤ŸåŒæ—¶æ”¯æŒLinuxå’ŒWindowsä¸¤ä¸ªå¹³å°ï¼Œå¿…é¡»é’ˆå¯¹è¿™ä¸¤ä¸ªæ“ä½œç³»ç»Ÿç¯å¢ƒçš„ä¸åŒè¿›è¡Œæ¡ä»¶ç¼–è¯‘ã€‚åœ¨Mini
CRTä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨å®WIN32ä¸ºæ ‡å‡†æ¥å†³å®šæ˜¯Windowsè¿˜æ˜¯Linuxã€‚å› æ­¤å®é™…çš„ä»£ç å¸¸å¸¸å‘ˆç°è¿™æ ·çš„ç»“æ„ï¼š</p>
<pre><code>#ifdef WIN32
//Windows éƒ¨åˆ†å®ç°ä»£ç 
#else
//Linux éƒ¨åˆ†å®ç°ä»£ç 
#endif
</code></pre>
<p>åœ¨æœ¬ç« ä¸­ï¼Œ#ifdef-#else-#endifè¿™ä¸ªæ¡ä»¶ç¼–è¯‘æŒ‡ä»¤ä¼šåŠ ç²—æ˜¾ç¤ºï¼Œä»¥æ–¹ä¾¿è¯»è€…åŒºåˆ†Windowså’ŒLinuxçš„ä»£ç ã€‚</p>
<p>é€šå¸¸æˆ‘ä»¬ä¼šæŠŠCRTçš„å„ä¸ªå‡½æ•°çš„å£°æ˜æ”¾åœ¨ä¸åŒçš„å¤´æ–‡ä»¶ä¸­ï¼Œæ¯”å¦‚IOç›¸å…³çš„ä½äºstdio.hï¼›å­—ç¬¦ä¸²å’Œå †ç›¸å…³çš„æ”¾åœ¨stdlib.hä¸­ã€‚ä¸ºäº†ç®€å•èµ·è§ï¼Œå°†Mini
CRTä¸­æ‰€æœ‰å‡½æ•°çš„å£°æ˜éƒ½æ”¾åœ¨minicrt.hä¸­ã€‚</p>
<h3 id="1311-å¼€å§‹"><a class="header" href="#1311-å¼€å§‹">13.1.1 å¼€å§‹</a></h3>
<p>é‚£ä¹ˆMini
CRTé¦–å…ˆè¯¥ä»å“ªå„¿å…¥æ‰‹å‘¢ï¼Ÿè¯šç„¶ï¼Œä»å…¥å£å‡½æ•°å¼€å§‹å…¥æ‰‹åº”è¯¥æ˜¯ä¸ªä¸é”™çš„é€‰æ‹©ã€‚åœ¨æœ¬ä¹¦çš„ç¬¬10ç« ä¸­ï¼Œå·²å¯¹Glibcå’ŒMSVC
CRTçš„å…¥å£å‡½æ•°è¿›è¡Œäº†åˆ†æï¼Œä¸‹é¢æˆ‘ä»¬å†å¯¹å…¥å£å‡½æ•°ç›¸å…³çš„å†…å®¹è¿›è¡Œæ¦‚æ‹¬ã€‚</p>
<ul>
<li>ç¨‹åºè¿è¡Œçš„æœ€åˆå…¥å£ç‚¹ä¸æ˜¯mainå‡½æ•°ï¼Œè€Œæ˜¯ç”±è¿è¡Œåº“ä¸ºå…¶æä¾›çš„å…¥å£å‡½æ•°ã€‚å®ƒä¸»è¦è´Ÿè´£ä¸‰éƒ¨åˆ†å·¥ä½œï¼šå‡†å¤‡å¥½ç¨‹åºè¿è¡Œç¯å¢ƒåŠåˆå§‹åŒ–è¿è¡Œåº“ï¼Œè°ƒç”¨mainå‡½æ•°æ‰§è¡Œç¨‹åºä¸»ä½“ï¼Œæ¸…ç†ç¨‹åºè¿è¡Œåçš„å„ç§èµ„æºã€‚</li>
<li>è¿è¡Œåº“ä¸ºæ‰€æœ‰ç¨‹åºæä¾›çš„å…¥å£å‡½æ•°åº”è¯¥ç›¸åŒï¼Œåœ¨é“¾æ¥ç¨‹åºæ—¶é¡»è¦æŒ‡å®šè¯¥å…¥å£å‡½æ•°åã€‚</li>
</ul>
<p>åœ¨æœ¬ç« èŠ‚é‡Œï¼Œå°†ä¸ºMini
CRTç¼–å†™è‡ªå·±çš„å…¥å£å‡½æ•°ã€‚ä¸ºäº†ä¿è¯è¿è¡Œåº“çš„å…¼å®¹æ€§ï¼ŒCRTå…¥å£å‡½æ•°åŒæ ·å¿…é¡»å…·æœ‰ä»¥ä¸Šç‰¹æ€§ã€‚</p>
<h4 id="å…¥å£å‡½æ•°"><a class="header" href="#å…¥å£å‡½æ•°">å…¥å£å‡½æ•°</a></h4>
<p>é¦–å…ˆï¼Œé¡»è¦ç¡®å®šå…¥å£å‡½æ•°çš„å‡½æ•°åŸå‹ï¼ŒåŒ…æ‹¬å‡½æ•°åã€è¾“å…¥å‚æ•°åŠè¿”å›å€¼ã€‚åœ¨è¿™é‡Œï¼Œå…¥å£å‡½æ•°å‘½åä¸ºmini_crt_entryã€‚ä¸ºäº†ç®€å•èµ·è§ï¼Œå®ƒæ²¡æœ‰è¾“å…¥å‚æ•°ï¼ŒåŒæ—¶æ²¡æœ‰è¿”å›å€¼ã€‚å…¶å®mini_crt_entryçš„è¿”å›å€¼æ²¡æœ‰æ„ä¹‰ï¼Œå› ä¸ºå®ƒæ°¸è¿œä¸ä¼šè¿”å›ï¼Œåœ¨å®ƒè¿”å›ä¹‹å‰å°±ä¼šè°ƒç”¨è¿›ç¨‹é€€å‡ºå‡½æ•°ç»“æŸè¿›ç¨‹ã€‚è¿™æ ·ï¼Œå…¥å£å‡½æ•°å…·æœ‰å¦‚ä¸‹å½¢å¼ï¼š</p>
<pre><code>void mini_crt_entry(void)
</code></pre>
<p>å‚ç…§ä¸Šé¢æ‰€æè¿°çš„å…¥å£å‡½æ•°çš„ä¸‰éƒ¨åˆ†å·¥ä½œï¼Œä»¥ä¸‹ä»£ç ä¸ºä¸€ä¸ªåŸºæœ¬æ¡†æ¶ã€‚</p>
<pre><code>void mini_crt_entry(void)
{
    // åˆå§‹åŒ–éƒ¨åˆ†
    int ret = main()
    // ç»“æŸéƒ¨åˆ†
    exit(ret);
}
</code></pre>
<p>è¿™é‡Œçš„åˆå§‹åŒ–ä¸»è¦è´Ÿè´£å‡†å¤‡å¥½ç¨‹åºè¿è¡Œçš„ç¯å¢ƒï¼ŒåŒ…æ‹¬å‡†å¤‡mainå‡½æ•°çš„å‚æ•°ã€åˆå§‹åŒ–è¿è¡Œåº“ï¼ŒåŒ…æ‹¬å †ã€IOç­‰ï¼Œç»“æŸéƒ¨åˆ†ä¸»è¦è´Ÿè´£æ¸…ç†ç¨‹åºè¿è¡Œèµ„æºã€‚åœ¨ä»¥ä¸‹å†…å®¹ä¸­ï¼Œå›´ç»•è¿™ä¸ªåŸºæœ¬æ¡†æ¶ï¼Œæˆ‘ä»¬å°†é€æ­¥æ‰©å±•è¡¥å……å…¥å£å‡½æ•°ã€‚</p>
<h4 id="mainå‚æ•°"><a class="header" href="#mainå‚æ•°">mainå‚æ•°</a></h4>
<p>æˆ‘ä»¬çŸ¥é“mainå‡½æ•°çš„åŸå‹ä¸ºï¼š</p>
<pre><code>int main(int argc, char* argv[]);
</code></pre>
<p>å…¶ä¸­argcå’Œargvåˆ†åˆ«æ˜¯mainå‡½æ•°çš„ä¸¤ä¸ªå‚æ•°ï¼Œå®ƒä»¬åˆ†åˆ«è¡¨ç¤ºè¿è¡Œç¨‹åºæ—¶çš„å‚æ•°ä¸ªæ•°å’ŒæŒ‡å‘å‚æ•°çš„å­—ç¬¦ä¸²æŒ‡é’ˆæ•°ç»„ã€‚åœ¨ç¬¬6ç« ä¸­å·²ç»ä»‹ç»è¿‡åœ¨Linuxç³»ç»Ÿä¸‹ï¼Œå½“è¿›ç¨‹è¢«åˆå§‹åŒ–æ—¶ï¼Œå®ƒçš„å †æ ˆç»“æ„ä¸­å°±ä¿å­˜ç€ç¯å¢ƒå˜é‡å’Œä¼ é€’ç»™mainå‡½æ•°çš„å‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ESPå¯„å­˜å™¨è·å¾—è¿™ä¸¤ä¸ªå‚æ•°ã€‚ä½†æ˜¯ä¸€æ—¦è¿›å…¥mini_crt_entryä¹‹åï¼ŒESPå¯„å­˜å™¨ä¼šéšç€å‡½æ•°çš„æ‰§è¡Œè€Œè¢«æ”¹å˜ï¼Œé€šè¿‡ç¬¬9ç« ä¸­å…³äºå‡½æ•°å¯¹äºå †æ ˆå¸§çš„çŸ¥è¯†ï¼Œå¯ä»¥çŸ¥é“EBPçš„å†…å®¹å°±æ˜¯è¿›å…¥å‡½æ•°åESP +
4ï¼ˆ4æ˜¯å› ä¸ºå‡½æ•°ç¬¬ä¸€æ¡æŒ‡ä»¤æ˜¯push ebpï¼‰ã€‚é‚£ä¹ˆå¯ä»¥æ¨æ–­å‡ºEBP -
4æ‰€æŒ‡å‘çš„å†…å®¹åº”è¯¥å°±æ˜¯argcï¼Œè€ŒEBP -
8åˆ™å°±æ˜¯argvã€‚æ•´ä¸ªå †æ ˆçš„åˆ†å¸ƒå¯ä»¥å¦‚å›¾13-1æ‰€ç¤ºã€‚</p>
<p><img src="../Images/13-1.jpg" alt="" /><br />
å›¾13-1 mainå‡½æ•°å‚æ•°</p>
<p>å¯¹äºWindowsç³»ç»Ÿæ¥è¯´ï¼Œå®ƒæä¾›äº†ç›¸åº”çš„APIç”¨äºå–å¾—è¿›ç¨‹çš„å‘½ä»¤è¡Œå‚æ•°ï¼Œè¿™ä¸ªAPIå«åšGetCommandLineï¼Œå®ƒä¼šè¿”å›æ•´ä¸ªå‘½ä»¤è¡Œå‚æ•°å­—ç¬¦ä¸²ã€‚ç”±äºmainå‡½æ•°æ‰€éœ€è¦çš„å‚æ•°æ˜¯å‘½ä»¤è¡Œå‚æ•°åˆ—è¡¨ï¼Œæ‰€ä»¥æˆ‘ä»¬å°†æ•´ä¸ªå‘½ä»¤è¡Œå­—ç¬¦ä¸²åˆ†å‰²æˆè‹¥å¹²ä¸ªå‚æ•°ï¼Œä»¥ç¬¦åˆargcå’Œargvçš„æ ¼å¼ã€‚</p>
<blockquote>
<p>åœ¨è¿™é‡Œæš‚æ—¶ä¸åˆ—å‡ºå®ç°çš„ä»£ç ï¼Œåœ¨ç« èŠ‚çš„æœ€åå°†åˆ—å‡ºè¿™ä¸€èŠ‚æ‰€å®ç°çš„Mini
CRTæºä»£ç ã€‚ä»¥åæ‰€æœ‰ä¸Mini CRTå®ç°ç›¸å…³çš„ç« èŠ‚éƒ½éµå¾ªè¿™ä¸€è§„åˆ™ã€‚</p>
</blockquote>
<h4 id="crtåˆå§‹åŒ–"><a class="header" href="#crtåˆå§‹åŒ–">CRTåˆå§‹åŒ–</a></h4>
<p>å®Œæˆäº†è·å–main
å‡½æ•°å‚æ•°çš„ä»£ç åï¼Œè¿˜åº”è¯¥åœ¨å…¥å£å‡½æ•°é‡Œå¯¹CRTè¿›è¡Œåˆå§‹åŒ–ã€‚ç”±äºMini
CRTæ‰€å®ç°çš„åŠŸèƒ½è¾ƒå°‘ï¼Œæ‰€ä»¥åˆå§‹åŒ–éƒ¨åˆ†ååˆ†ç®€å•ã€‚éœ€è¦åˆå§‹åŒ–çš„ä¸»è¦æ˜¯å †å’ŒIOéƒ¨åˆ†ã€‚åœ¨å †è¢«åˆå§‹åŒ–ä¹‹å‰ï¼Œmalloc/freeå‡½æ•°æ˜¯æ²¡æœ‰åŠæ³•ä½¿ç”¨çš„ã€‚æˆ‘ä»¬å®šä¹‰å †çš„åˆå§‹åŒ–å‡½æ•°ä¸ºmini_crt_heap_init()ï¼›IOéƒ¨åˆ†çš„åˆå§‹åŒ–å‡½æ•°ä¸ºmini_crt_io_init()ã€‚è¿™ä¸¤ä¸ªå‡½æ•°çš„è¿”å›å€¼éƒ½æ˜¯æ•´æ•°ç±»å‹çš„ï¼Œè¿”å›é0å³è¡¨ç¤ºåˆå§‹åŒ–æˆåŠŸï¼Œå¦åˆ™è¡¨ç¤ºå¤±è´¥ã€‚è¿™ä¸¤ä¸ªå‡½æ•°çš„å®ç°å°†åœ¨åé¢ä»‹ç»å †å®ç°å’ŒIOå®ç°æ—¶è¯¦ç»†ä»‹ç»ã€‚</p>
<h4 id="ç»“æŸéƒ¨åˆ†"><a class="header" href="#ç»“æŸéƒ¨åˆ†">ç»“æŸéƒ¨åˆ†</a></h4>
<p>Mini
CRTç»“æŸéƒ¨åˆ†å¾ˆç®€å•ï¼Œå®ƒè¦å®Œæˆä¸¤é¡¹ä»»åŠ¡ï¼šä¸€ä¸ªå°±æ˜¯è°ƒç”¨ç”±atexit()æ³¨å†Œçš„é€€å‡ºå›è°ƒå‡½æ•°ï¼›å¦å¤–ä¸€ä¸ªå°±æ˜¯å®ç°ç»“æŸè¿›ç¨‹ã€‚è¿™ä¸¤é¡¹ä»»åŠ¡éƒ½ç”±exit()å‡½æ•°å®Œæˆï¼Œè¿™ä¸ªå‡½æ•°åœ¨Linuxçš„å®ç°å·²ç»åœ¨ç¬¬4ç« ä¸­ç¢°åˆ°è¿‡äº†ï¼Œå®ƒè°ƒç”¨Linuxçš„1å·ç³»ç»Ÿè°ƒç”¨å®ç°è¿›ç¨‹ç»“æŸï¼Œebxè¡¨ç¤ºè¿›ç¨‹é€€å‡ºç ï¼›è€ŒWindowsåˆ™æä¾›äº†ä¸€ä¸ªå«åšExitProcessçš„APIï¼Œç›´æ¥è°ƒç”¨è¯¥APIå³å¯ç»“æŸè¿›ç¨‹ã€‚</p>
<p>ä¸è¿‡åœ¨è¿›è¡Œç³»ç»Ÿè°ƒç”¨æˆ–APIä¹‹å‰ï¼Œexit()è¿˜æœ‰ä¸€ä¸ªä»»åŠ¡å°±æ˜¯è°ƒç”¨ç”±atexit()æ³¨å†Œçš„é€€å‡ºå›è°ƒå‡½æ•°ï¼Œè¿™ä¸ªä»»åŠ¡é€šè¿‡è°ƒç”¨mini_crt_exit_routine()å®ç°ã€‚æˆ‘ä»¬åœ¨ç¬¬10ç« ä¸­å·²ç»äº†è§£åˆ°ï¼Œatexit()æ³¨å†Œå›è°ƒå‡½æ•°çš„æœºåˆ¶ä¸»è¦æ˜¯ç”¨æ¥å®ç°å…¨å±€å¯¹è±¡çš„ææ„çš„ï¼Œåœ¨è¿™ä¸€èŠ‚ä¸­æš‚æ—¶ä¸æ‰“ç®—è®©Mini
CRTæ”¯æŒC++ï¼Œæ‰€ä»¥æš‚æ—¶å°†è°ƒç”¨mini_crt_exit_routine()è¿™ä¸ªå‡½æ•°çš„é‚£è¡Œä»£ç å»æ‰ã€‚</p>
<p>æœ€ç»ˆMini CRTçš„å…¥å£å‡½æ•°mini_crt_entryçš„ä»£ç å¦‚æ¸…å•13-1æ‰€ç¤ºã€‚</p>
<p>æ¸…å•13-1 entry.c</p>
<pre><code>//entry.c
#include "minicrt.h"

#ifdef WIN32
#include &lt;Windows.h&gt;
#endif

extern int main(int argc, char* argv[]);
void exit(int);

static void crt_fatal_error(const char* msg)
{
    // printf("fatal error: %s", msg);
    exit(1);
}

void mini_crt_entry(void)
{
    int ret;

#ifdef WIN32
       int flag = 0;
    int argc = 0;
    char* argv[16]; // æœ€å¤š16ä¸ªå‚æ•°
    char* cl = GetCommandLineA();
    
    // è§£æå‘½ä»¤è¡Œ
    argv[0] = cl;
    argc++;
    while(*cl) {
        if(*cl == '\"')
            if(flag == 0) flag = 1;
            else flag = 0;
        else if(*cl == ' ' &amp;&amp; flag == 0) {
            if(*(cl+1)) {
                argv[argc] = cl + 1;
                argc++;
            }
            *cl = '\0';
        }
        cl++;
    }
#else
    int argc;
    char** argv;

    char* ebp_reg = 0;
    // ebp_reg = %ebp
    asm("movl %%ebp,%0 \n":"=r"(ebp_reg));

    argc = *(int*)(ebp_reg + 4);
    argv = (char**)(ebp_reg + 8);

#endif

    if (!mini_crt_heap_init())
        crt_fatal_error("heap initialize failed");

    if (!mini_crt_io_init())
        crt_fatal_error("IO initialize failed");
    
    ret = main(argc,argv);
    exit(ret);
}

void exit(int exitCode)
{
    //mini_crt_call_exit_routine();
#ifdef WIN32
    ExitProcess(exitCode);
#else
    asm( "movl %0,%%ebx \n\t"
         "movl $1,%%eax \n\t"
         "int $0x80     \n\t" 
         "hlt           \n\t"::"m"(exitCode));
#endif
}
</code></pre>
<p>åœ¨ä¸Šé¢è¿™ä¸ªå®ç°ä¸­ï¼ŒMini
CRTçš„å…¥å£å‡½æ•°åŸºæœ¬å®Œæˆæ‰€éœ€è¦çš„åŠŸèƒ½ã€‚å®ƒçš„Windowsç‰ˆå¯¹å‘½ä»¤è¡Œå‚æ•°è¿›è¡Œäº†åˆ†å‰²ï¼Œè¿™ä¸ªåˆ†å‰²ç®—æ³•å®é™…ä¸Šè¿˜æ˜¯æœ‰é—®é¢˜çš„ï¼Œæ¯”å¦‚ä¸¤ä¸ªå‚æ•°ä¹‹é—´éš”å¤šä¸ªç©ºæ ¼å°±ä¼šå‘ç”Ÿé—®é¢˜ã€‚å½“ç„¶è¿™äº›é—®é¢˜ä¸å½±å“æˆ‘ä»¬ç†è§£Mini
CRTçš„å…¥å£å‡½æ•°çš„ä¸»å¹²éƒ¨åˆ†ã€‚</p>
<h3 id="1312-å †çš„å®ç°"><a class="header" href="#1312-å †çš„å®ç°">13.1.2 å †çš„å®ç°</a></h3>
<p>æœ‰äº†CRTçš„å…¥å£å‡½æ•°ã€exit()å‡½æ•°ä¹‹åï¼Œä¸‹ä¸€æ­¥çš„ç›®æ ‡å°±æ˜¯å®ç°å †çš„æ“ä½œï¼Œå³malloc()å‡½æ•°å’Œfree()å‡½æ•°ã€‚å½“ç„¶å †çš„å®ç°æ–¹æ³•æœ‰å¾ˆå¤šï¼Œåœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿå¹³å°ä¸Šä¹Ÿæœ‰å¾ˆå¤šå¯ä»¥é€‰æ‹©çš„æ–¹æ¡ˆï¼Œåœ¨éµå¾ªMini
CRTçš„åŸåˆ™ä¸‹ï¼Œæˆ‘ä»¬å°†Mini CRTå †çš„å®ç°å½’çº³ä¸ºä¸‹é¢å‡ æ¡ã€‚</p>
<ul>
<li>å®ç°ä¸€ä¸ªä»¥ç©ºé—²é“¾è¡¨ç®—æ³•ä¸ºåŸºç¡€çš„å †ç©ºé—´åˆ†é…ç®—æ³•ã€‚</li>
<li>ä¸ºäº†ç®€å•èµ·è§ï¼Œå †ç©ºé—´å¤§å°å›ºå®šä¸º32MBï¼Œåˆå§‹åŒ–ä¹‹åç©ºé—´ä¸å†æ‰©å±•æˆ–ç¼©å°ã€‚</li>
<li>åœ¨Windowså¹³å°ä¸‹ä¸ä½¿ç”¨HeapAllocç­‰å †åˆ†é…ç®—æ³•ï¼Œé‡‡ç”¨VirtualAllocå‘ç³»ç»Ÿç›´æ¥ç”³è¯·32MBç©ºé—´ï¼Œç”±æˆ‘ä»¬è‡ªå·±çš„å †åˆ†é…ç®—æ³•å®ç°mallocã€‚</li>
<li>åœ¨Linuxå¹³å°ä¸‹ï¼Œä½¿ç”¨brkå°†æ•°æ®æ®µç»“æŸåœ°å€å‘åè°ƒæ•´32MBï¼Œå°†è¿™å—ç©ºé—´ä½œä¸ºå †ç©ºé—´ã€‚</li>
</ul>
<blockquote>
<p>brkç³»ç»Ÿè°ƒç”¨å¯ä»¥è®¾ç½®è¿›ç¨‹çš„æ•°æ®æ®µè¾¹ç•Œï¼Œè€Œsbrkå¯ä»¥ç§»åŠ¨è¿›ç¨‹çš„æ•°æ®æ®µè¾¹ç•Œã€‚æ˜¾ç„¶ï¼Œå¦‚æœå°†æ•°æ®æ®µè¾¹ç•Œåç§»ï¼Œå°±ç›¸å½“äºåˆ†é…äº†ä¸€å®šé‡çš„å†…å­˜ã€‚</p>
<p>ç”±brk/sbrkåˆ†é…çš„å†…å­˜å’ŒVirtualAllocåˆ†é…çš„ä¸€æ ·ï¼Œå®ƒä»¬ä»…ä»…æ˜¯åˆ†é…äº†è™šæ‹Ÿç©ºé—´ï¼Œè¿™äº›ç©ºé—´ä¸€å¼€å§‹æ˜¯ä¸ä¼šæäº¤çš„ï¼ˆå³ä¸åˆ†é…ç‰©ç†é¡µé¢ï¼‰ï¼Œå½“è¿›ç¨‹è¯•å›¾è®¿é—®æŸä¸€ä¸ªåœ°å€çš„æ—¶å€™ï¼Œæ“ä½œç³»ç»Ÿä¼šæ£€æµ‹åˆ°è®¿é—®å¼‚å¸¸ï¼Œå¹¶ä¸”ä¸ºè¢«è®¿é—®çš„åœ°å€æ‰€åœ¨çš„é¡µåˆ†é…ç‰©ç†é¡µé¢ã€‚</p>
<p>åœ¨æŸäº›äººçš„"é»‘è¯"é‡Œï¼Œè·µè¸ï¼ˆtrampleï¼‰ä¸€å—å†…å­˜æŒ‡çš„æ˜¯å»è¯»å†™è¿™å—å†…å­˜çš„æ¯ä¸€ä¸ªå­—èŠ‚ã€‚brkæ‰€åˆ†é…çš„è™šåœ°å€å°±æ˜¯éœ€è¦åœ¨è·µè¸ä¹‹åæ‰ä¼šè¢«æ“ä½œç³»ç»Ÿè‡ªåŠ¨åœ°åˆ†é…å®é™…é¡µé¢ã€‚æ‰€ä»¥å¾ˆå¤šæ—¶å€™æŒ‰é¡µéœ€æ±‚åˆ†é…ï¼ˆPage
Demand Allocationï¼‰åˆè¢«ç§°ä¸ºæŒ‰è·µè¸åˆ†é…ï¼ˆAlloc On Trampleï¼Œ AOTï¼‰ã€‚ğŸ™‚</p>
</blockquote>
<p>æˆ‘ä»¬åœ¨ç¬¬9ç« æ—¶å·²ç»ä»‹ç»è¿‡å †åˆ†é…ç®—æ³•çš„åŸç†ï¼Œåœ¨å®ç°ä¸Šä¹ŸåŸºæœ¬ä¸€è‡´ã€‚æ•´ä¸ªå †ç©ºé—´æŒ‰ç…§æ˜¯å¦è¢«å ç”¨è€Œè¢«åˆ†å‰²æˆäº†è‹¥å¹²ä¸ªç©ºé—²ï¼ˆFreeï¼‰å—å’Œå ç”¨ï¼ˆUsedï¼‰å—ï¼Œå®ƒä»¬ä¹‹é—´ç”±åŒå‘é“¾è¡¨é“¾æ¥èµ·æ¥ã€‚</p>
<p>å½“ç”¨æˆ·è¦ç”³è¯·ä¸€å—å†…å­˜æ—¶ï¼Œå †åˆ†é…ç®—æ³•å°†éå†æ•´ä¸ªé“¾è¡¨ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€å—è¶³å¤Ÿå¤§çš„ç©ºé—²å—ï¼Œå¦‚æœè¿™ä¸ªç©ºé—²å—å¤§å°åˆšå¥½ç­‰äºæ‰€ç”³è¯·çš„å¤§å°ï¼Œé‚£ä¹ˆç›´æ¥å°†è¿™ä¸ªç©ºé—²å—æ ‡è®°ä¸ºå ç”¨å—ï¼Œç„¶åå°†å®ƒçš„åœ°å€è¿”å›ç»™ç”¨æˆ·ï¼›å¦‚æœç©ºé—²å—å¤§å°å¤§äºæ‰€ç”³è¯·çš„å¤§å°ï¼Œé‚£ä¹ˆè¿™ä¸ªç©ºé—²å—å°†è¢«åˆ†å‰²æˆä¸¤å—ï¼Œå…¶ä¸­ä¸€å—å¤§å°ä¸ºç”³è¯·çš„å¤§å°ï¼Œæ ‡è®°ä¸ºå ç”¨ï¼Œå¦å¤–ä¸€å—ä¸ºç©ºé—²å—ã€‚</p>
<p>å½“ç”¨æˆ·é‡Šæ”¾æŸä¸€å—ç©ºé—´æ—¶ï¼Œå †åˆ†é…ç®—æ³•ä¼šåˆ¤åˆ«è¢«é‡Šæ”¾å—å‰åä¸¤ä¸ªå—æ˜¯å¦ä¸ºç©ºé—²å—ï¼Œå¦‚æœæ˜¯ï¼Œåˆ™å°†å®ƒä»¬åˆå¹¶æˆä¸€ä¸ªå¤§çš„ç©ºé—²å—ã€‚</p>
<p>æ•´ä¸ªå †åˆ†é…ç®—æ³•ä»å®ç°ä¸Šçœ‹ååˆ†ç®€å•ï¼Œä»…ä»…åªæœ‰100è¡Œå·¦å³ï¼Œè€Œä¸”è¿˜åŒ…å«äº†Linuxçš„brkç³»ç»Ÿè°ƒç”¨çš„å®ç°ã€‚Mini
CRTçš„å †åˆ†é…ç®—æ³•æºä»£ç å¦‚æ¸…å•13-2æ‰€ç¤ºã€‚</p>
<p>æ¸…å•13-2 malloc.c</p>
<pre><code>// malloc.c
#include "minicrt.h"

typedef struct _heap_header
{
    enum {
        HEAP_BLOCK_FREE = 0xABABABAB,   // magic number of free block
        HEAP_BLOCK_USED = 0xCDCDCDCD,   // magic number of used block
    } type;                             // block type FREE/USED

    unsigned size;                        // block size including header
    struct _heap_header* next;
    struct _heap_header* prev;
} heap_header;

#define ADDR_ADD(a,o) (((char*)(a)) + o)
#define HEADER_SIZE (sizeof(heap_header))

static heap_header* list_head = NULL;

void free(void* ptr)
{
    heap_header* header = (heap_header*)ADDR_ADD(ptr, -HEADER_SIZE);
    if(header-&gt;type != HEAP_BLOCK_USED) 
        return;

    header-&gt;type = HEAP_BLOCK_FREE;
    if(header-&gt;prev != NULL &amp;&amp; header-&gt;prev-&gt;type == HEAP_BLOCK_FREE) {
        // merge
        header-&gt;prev-&gt;next = header-&gt;next;
        if(header-&gt;next != NULL)
            header-&gt;next-&gt;prev = header-&gt;prev;
        header-&gt;prev-&gt;size += header-&gt;size;

 header = header-&gt;prev;
    }

    if(header-&gt;next != NULL &amp;&amp; header-&gt;next-&gt;type == HEAP_BLOCK_FREE) {
        // merge
        header-&gt;size += header-&gt;next-&gt;size;
        header-&gt;next = header-&gt;next-&gt;next;
    }
}

void* malloc( unsigned size )
{
    heap_header *header;

    if( size == 0 ) 
        return NULL;

    header = list_head;
    while(header != 0) {
        if(header-&gt;type == HEAP_BLOCK_USED) {
            header = header-&gt;next;
            continue;
        }
            
        if(header-&gt;size &gt; size + HEADER_SIZE &amp;&amp;
                      header-&gt;size &lt;= size + HEADER_SIZE * 2) {
            header-&gt;type = HEAP_BLOCK_USED;
        }
        if(header-&gt;size &gt; size + HEADER_SIZE * 2) {
            // split
            heap_header* next = (heap_header*)ADDR_ADD(header,size + 
                                     HEADER_SIZE);
            next-&gt;prev = header;
            next-&gt;next = header-&gt;next;
            next-&gt;type = HEAP_BLOCK_FREE;
            next-&gt;size = header-&gt;size - (size - HEADER_SIZE);
            header-&gt;next = next;
            header-&gt;size = size + HEADER_SIZE;
            header-&gt;type = HEAP_BLOCK_USED;
            return ADDR_ADD(header,HEADER_SIZE);
        }
        header = header-&gt;next;
    }

    return NULL;
}

#ifndef WIN32
// Linux brk system call
static int brk(void* end_data_segment) {
    int ret = 0;
    // brk system call number: 45
    // in /usr/include/asm-i386/unistd.h:
    // #define __NR_brk 45
    asm( "movl $45, %%eax     \n\t"
         "movl %1, %%ebx    \n\t"
             "int $0x80         \n\t"
             "movl %%eax, %0    \n\t"
             : "=r"(ret): "m"(end_data_segment) );
}
#endif

#ifdef WIN32
#include &lt;Windows.h&gt;
#endif

int mini_crt_heap_init()
{
    void* base = NULL;
    heap_header *header = NULL;
    // 32 MB heap size
    unsigned heap_size = 1024 * 1024 * 32;

#ifdef WIN32
    base = VirtualAlloc(0,heap_size,MEM_COMMIT | MEM_RESERVE,PAGE_READWRITE);
    if(base == NULL)
        return 0;
#else
    base = (void*)brk(0);
    void* end = ADDR_ADD(base, heap_size);
    end = (void*)brk(end);
    if(!end)
        return 0;
#endif

    header = (heap_header*)base;

    header-&gt;size = heap_size;
    header-&gt;type = HEAP_BLOCK_FREE;
    header-&gt;next = NULL;
    header-&gt;prev = NULL;

    list_head = header;
    return 1;
}
</code></pre>
<p>æˆ‘ä»¬åœ¨malloc.cä¸­å®ç°äº†3ä¸ªå¯¹å¤–çš„æ¥å£å‡½æ•°ï¼Œåˆ†åˆ«æ˜¯ï¼šmini_crt_init_heapã€mallocå’Œfreeã€‚ä¸è¿‡è¿™ä¸ªå †çš„å®ç°è¿˜æ¯”è¾ƒç®€é™‹ï¼šå®ƒçš„æœç´¢ç®—æ³•æ˜¯O(n)çš„ï¼ˆnæ˜¯å †ä¸­åˆ†é…çš„å—çš„æ•°é‡ï¼‰ï¼›å †çš„ç©ºé—´å›ºå®šä¸º32MBï¼Œæ²¡æœ‰åŠæ³•æ‰©å¼ ï¼›å®ƒæ²¡æœ‰å®ç°reallocã€callocå‡½æ•°ï¼›å®ƒæ²¡æœ‰å¾ˆå¥½çš„å †æº¢å‡ºé˜²èŒƒæœºåˆ¶ï¼›å®ƒä¸æ”¯æŒå¤šçº¿ç¨‹åŒæ—¶è®¿é—®ç­‰ç­‰ã€‚</p>
<p>è™½ç„¶å®ƒå¾ˆç®€é™‹ï¼Œä½†æ˜¯å®ƒä½“ç°å‡ºäº†å †åˆ†é…ç®—æ³•çš„æœ€æœ¬è´¨çš„å‡ ä¸ªç‰¹å¾ï¼Œå…¶ä»–çš„è¯¸å¦‚æ”¹è¿›æœç´¢é€Ÿåº¦ã€æ‰©å±•å †ç©ºé—´ã€å¤šçº¿ç¨‹æ”¯æŒç­‰éƒ½å¯ä»¥åœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œæ”¹è¿›ï¼Œç”±äºç¯‡å¹…æœ‰é™ï¼Œæˆ‘ä»¬ä¹Ÿä¸æ‰“ç®—ä¸€ä¸€å®ç°å®ƒä»¬ï¼Œè¯»è€…å¦‚æœæœ‰å…´è¶£ï¼Œå¯ä»¥è‡ªå·±è€ƒè™‘åŠ¨æ‰‹æ”¹è¿›Mini
CRTï¼Œä¸ºå®ƒå¢åŠ ä¸Šè¿°ç‰¹æ€§ã€‚</p>
<h3 id="1313-ioä¸æ–‡ä»¶æ“ä½œ"><a class="header" href="#1313-ioä¸æ–‡ä»¶æ“ä½œ">13.1.3 IOä¸æ–‡ä»¶æ“ä½œ</a></h3>
<p>åœ¨ä¸ºMini
CRTæ·»åŠ äº†mallocå’Œfreeä¹‹åï¼Œæ¥ç€å°†ä¸ºå®ƒä»¬å®ç°IOæ“ä½œã€‚IOéƒ¨åˆ†åœ¨ä»»ä½•è½¯ä»¶ä¸­éƒ½æ˜¯æœ€ä¸ºå¤æ‚çš„ï¼Œåœ¨CRTä¸­ä¹Ÿä¸ä¾‹å¤–ã€‚åœ¨ä¼ ç»Ÿçš„Cè¯­è¨€å’ŒUNIXé‡Œé¢ï¼ŒIOå’Œæ–‡ä»¶æ˜¯åŒä¸€ä¸ªæ¦‚å¿µï¼Œæ‰€æœ‰çš„IOéƒ½æ˜¯é€šè¿‡å¯¹æ–‡ä»¶çš„æ“ä½œæ¥å®ç°çš„ã€‚å› æ­¤ï¼Œåªè¦å®ç°äº†æ–‡ä»¶çš„åŸºæœ¬æ“ä½œï¼ˆfopenã€freadã€fwriteã€fcloseå’Œfseekï¼‰ï¼Œå³ä½¿å®Œæˆäº†Mini
CRTçš„IOéƒ¨åˆ†ã€‚ä¸å †çš„å®ç°ä¸€æ ·ï¼Œæˆ‘ä»¬éœ€è¦ä¸ºMini
CRTçš„IOéƒ¨åˆ†è®¾è®¡ä¸€äº›å®ç°çš„åŸºæœ¬åŸåˆ™ï¼š</p>
<ul>
<li>ä»…å®ç°åŸºæœ¬çš„æ–‡ä»¶æ“ä½œï¼ŒåŒ…æ‹¬fopenã€freadã€fwriteã€fcloseåŠfseekã€‚</li>
<li>ä¸ºäº†ç®€å•èµ·è§ï¼Œä¸å®ç°ç¼“å†²ï¼ˆBufferï¼‰æœºåˆ¶ã€‚</li>
<li>ä¸å¯¹Windowsä¸‹çš„æ¢è¡Œæœºåˆ¶è¿›è¡Œè½¬æ¢ï¼Œå³"\r\n"ä¸"\n"ä¹‹é—´ä¸è¿›è¡Œè½¬æ¢ã€‚</li>
<li>æ”¯æŒä¸‰ä¸ªæ ‡å‡†çš„è¾“å…¥è¾“å‡ºstdinã€stdoutå’Œstderrã€‚</li>
<li>åœ¨Windowsä¸‹ï¼Œæ–‡ä»¶åŸºæœ¬æ“ä½œå¯ä»¥ä½¿ç”¨APIï¼šCreateFileã€ReadFileã€WriteFileã€CloseHandleå’ŒSetFilePointerå®ç°ã€‚</li>
<li>Linuxä¸åƒWindowsé‚£æ ·æœ‰APIæ¥å£ï¼Œæˆ‘ä»¬å¿…é¡»ä½¿ç”¨å†…åµŒæ±‡ç¼–å®ç°openã€readã€writeã€closeå’Œseekè¿™å‡ ä¸ªç³»ç»Ÿè°ƒç”¨ã€‚</li>
<li>fopenæ—¶ä»…åŒºåˆ†"r"ã€"w"å’Œ"+"è¿™å‡ ç§æ¨¡å¼åŠå®ƒä»¬çš„ç»„åˆï¼Œä¸å¯¹æ–‡æœ¬æ¨¡å¼å’ŒäºŒè¿›åˆ¶æ¨¡å¼è¿›è¡ŒåŒºåˆ†ï¼Œä¸æ”¯æŒè¿½åŠ æ¨¡å¼ï¼ˆ"a"ï¼‰ã€‚</li>
</ul>
<p>Mini CRTçš„IOéƒ¨åˆ†å®ç°æºä»£ç å¦‚æ¸…å•13-3æ‰€ç¤ºã€‚</p>
<p>æ¸…å•13-3 stdio.c</p>
<pre><code>// stdio.c
#include "minicrt.h"

int mini_crt_io_init()
{
    return 1;
}

#ifdef WIN32
#include &lt;Windows.h&gt;

FILE* fopen( const char *filename,const char *mode )
{
    HANDLE hFile = 0;
    int access = 0;
    int creation = 0;

    if(strcmp(mode, "w") == 0) {
        access |= GENERIC_WRITE;
        creation |= CREATE_ALWAYS;
    }

    if(strcmp(mode, "w+") == 0) {
 access |=  GENERIC_WRITE | GENERIC_READ;
        creation |= CREATE_ALWAYS;
    }
        
    if(strcmp(mode, "r") == 0) {
        access |=  GENERIC_READ;
        creation += OPEN_EXISTING;
    }

    if(strcmp(mode, "r+") == 0) {
        access |=  GENERIC_WRITE | GENERIC_READ;
        creation |= TRUNCATE_EXISTING;
    }


    hFile = CreateFileA(filename, access, 0, 0, creation, 0, 0);
    if (hFile == INVALID_HANDLE_VALUE)
        return 0;

    return (FILE*)hFile;
}

int fread(void* buffer, int size, int count, FILE *stream)
{
    int read = 0;
    if (!ReadFile( (HANDLE)stream, buffer, size * count, &amp;read, 0))
        return 0;
    return read;
}

int fwrite(const void* buffer, int size, int count, FILE *stream)
{
    int written = 0;
    if (!WriteFile( (HANDLE)stream, buffer, size * count, &amp;written, 0))
        return 0;
    return written;
}
int fclose(FILE* fp)
{
    return CloseHandle((HANDLE)fp);
}

int fseek(FILE* fp, int offset, int set)
{
    return SetFilePointer((HANDLE)fp, offset, 0, set);
}

#else // #ifdef WIN32

static int open(const char *pathname, int flags, int mode)
{
    int fd = 0;
    asm("movl $5,%%eax    \n\t"
        "movl %1,%%ebx    \n\t"
        "movl %2,%%ecx  \n\t"
        "movl %3,%%edx    \n\t"
        "int $0x80        \n\t"
        "movl %%eax,%0    \n\t":
        "=m"(fd):"m"(pathname),"m"(flags),"m"(mode));
}

static int read( int fd, void* buffer, unsigned size)
{
    int ret = 0;
    asm("movl $3,%%eax    \n\t"
        "movl %1,%%ebx    \n\t"
        "movl %2,%%ecx  \n\t"
        "movl %3,%%edx    \n\t"
        "int $0x80        \n\t"
        "movl %%eax,%0    \n\t":
        "=m"(ret):"m"(fd),"m"(buffer),"m"(size));
    return ret;
}

static int write( int fd, const void* buffer, unsigned size)
{
    int ret = 0;
    asm("movl $4,%%eax    \n\t"
        "movl %1,%%ebx    \n\t"
        "movl %2,%%ecx  \n\t"
        "movl %3,%%edx    \n\t"
        "int $0x80        \n\t"
        "movl %%eax,%0    \n\t":
        "=m"(ret):"m"(fd),"m"(buffer),"m"(size));
    return ret;
}

static int close(int fd)
{
    int ret = 0;
    asm("movl $6,%%eax    \n\t"
        "movl %1,%%ebx    \n\t"
        "int $0x80        \n\t"
        "movl %%eax,%0    \n\t":
        "=m"(ret):"m"(fd));
    return ret;
}

static int seek(int fd, int offset, int mode)
{
    int ret = 0;
    asm("movl $19,%%eax    \n\t"
        "movl %1,%%ebx    \n\t"
        "movl %2,%%ecx  \n\t"
        "movl %3,%%edx    \n\t"
        "int $0x80        \n\t"
        "movl %%eax,%0    \n\t":
        "=m"(ret):"m"(fd),"m"(offset),"m"(mode));
    return ret;
}

FILE *fopen( const char *filename,const char *mode )
{
    int fd = -1;
    int flags = 0;
    int access = 00700; // åˆ›å»ºæ–‡ä»¶çš„æƒé™

// æ¥è‡ªäº/usr/include/bits/fcntl.h
// æ³¨æ„ï¼šä»¥0å¼€å§‹çš„æ•°å­—æ˜¯å…«è¿›åˆ¶çš„
#define O_RDONLY             00
#define O_WRONLY             01
#define O_RDWR               02
#define O_CREAT            0100
#define O_TRUNC           01000
#define O_APPEND          02000

    if(strcmp(mode, "w") == 0)
        flags |= O_WRONLY | O_CREAT | O_TRUNC;

    if(strcmp(mode, "w+") == 0)
        flags |=  O_RDWR | O_CREAT | O_TRUNC;
        
    if(strcmp(mode, "r") == 0)
        flags |=  O_RDONLY;

    if(strcmp(mode, "r+") == 0)
        flags |=  O_RDWR | O_CREAT;

    fd = open(filename, flags, access);
    return (FILE*)fd;
}

int fread(void* buffer, int size, int count, FILE* stream)
{    
    return read((int)stream, buffer, size * count);
}

int fwrite(const void* buffer, int size, int count, FILE* stream)
{
    return write((int)stream, buffer, size * count);
}

int fclose(FILE* fp)
{
    return close((int)fp);
}

int fseek(FILE* fp, int offset, int set)
{
    return seek((int)fp, offset, set);
}

#endif
</code></pre>
<p>å¦å¤–è¿˜æœ‰ä¸€æ®µä¸æ–‡ä»¶æ“ä½œç›¸å…³çš„å£°æ˜é¡»æ”¾åœ¨minicrt.hé‡Œé¢ï¼š</p>
<pre><code>typedef int FILE;
#define EOF (-1)

#ifdef WIN32
#define stdin       ((FILE*)(GetStdHandle(STD_INPUT_HANDLE)))
#define stdout      ((FILE*)(GetStdHandle(STD_OUTPUT_HANDLE)))
#define stderr      ((FILE*)(GetStdHandle(STD_ERROR_HANDLE)))
#else
#define stdin       ((FILE*)0)
#define stdout      ((FILE*)1)
#define stderr      ((FILE*)2)
#endif
</code></pre>
<p>åœ¨ä¸Šé¢çš„Mini CRT
IOä¸æ–‡ä»¶æ“ä½œçš„å®ç°ä¸­ï¼Œæˆ‘ä»¬çœç•¥äº†ç°å®CRTä¸­å¾ˆå¤šå†…å®¹ï¼ŒåŒ…æ‹¬æ¢è¡Œç¬¦è½¬æ¢ã€æ–‡ä»¶ç¼“å†²ç­‰ã€‚ç”±äºçœç•¥äº†è¿™äº›å†…å®¹ï¼Œé‚£ä¹ˆMini
CRTç›¸å½“äºä»…ä»…æ˜¯å¯¹ç³»ç»Ÿè°ƒç”¨æˆ–Windows
APIçš„ä¸€ä¸ªç®€å•åŒ…è£…ï¼Œè€ŒFILEç»“æ„ä¹Ÿå¯ä»¥è¢«çœç•¥ï¼Œå®ƒåœ¨Mini
CRTä¸­æ˜¯è¢«å¿½ç•¥çš„ï¼ŒFILE*è¿™ä¸ªç±»å‹åœ¨Windowsä¸‹å®é™…ä¸Šæ˜¯å†…æ ¸å¥æŸ„ï¼Œè€Œåœ¨Linuxä¸‹åˆ™æ˜¯æ–‡ä»¶æè¿°ç¬¦ï¼Œå®ƒå¹¶ä¸æ˜¯æŒ‡å‘FILEç»“æ„çš„åœ°å€ã€‚</p>
<p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œåœ¨Windowsä¸‹ï¼Œæ ‡å‡†è¾“å…¥è¾“å‡ºå¹¶ä¸æ˜¯æ–‡ä»¶æè¿°ç¬¦0ã€1å’Œ2ï¼Œè€Œæ˜¯è¦é€šè¿‡ä¸€ä¸ªå«åšGetStdHandleçš„APIè·å¾—ã€‚</p>
<p>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œåœ¨Windowsä¸‹ï¼Œæ ‡å‡†è¾“å…¥è¾“å‡ºå¹¶ä¸æ˜¯æ–‡ä»¶æè¿°ç¬¦0ã€1å’Œ2ï¼Œè€Œæ˜¯è¦é€šè¿‡ä¸€ä¸ªå«åšGetStdHandleçš„APIè·å¾—ã€‚</p>
<p>ç”±äºçœç•¥äº†è¯¸å¤šå®ç°å†…å®¹ï¼Œæ‰€ä»¥CRT
IOéƒ¨åˆ†ç”šè‡³å¯ä»¥ä¸è¦åšä»»ä½•åˆå§‹åŒ–ï¼Œäºæ˜¯IOçš„åˆå§‹åŒ–å‡½æ•°mini_crt_init_ioä¹Ÿå½¢åŒè™šè®¾ï¼Œä»…ä»…æ˜¯ä¸€ä¸ªç©ºå‡½æ•°è€Œå·²ã€‚</p>
<h3 id="1314-å­—ç¬¦ä¸²ç›¸å…³æ“ä½œ"><a class="header" href="#1314-å­—ç¬¦ä¸²ç›¸å…³æ“ä½œ">13.1.4 å­—ç¬¦ä¸²ç›¸å…³æ“ä½œ</a></h3>
<p>å­—ç¬¦ä¸²ç›¸å…³çš„æ“ä½œä¹Ÿæ˜¯CRTçš„ä¸€éƒ¨åˆ†ï¼ŒåŒ…æ‹¬è®¡ç®—å­—ç¬¦ä¸²é•¿åº¦ã€æ¯”è¾ƒä¸¤ä¸ªå­—ç¬¦ä¸²ã€æ•´æ•°ä¸å­—ç¬¦ä¸²ä¹‹é—´çš„è½¬æ¢ç­‰ã€‚ç”±äºè¿™éƒ¨åˆ†åŠŸèƒ½æ— é¡»æ¶‰åŠä»»ä½•ä¸å†…æ ¸äº¤äº’ï¼Œæ˜¯çº¯ç²¹çš„ç”¨æˆ·æ€çš„è®¡ç®—ï¼Œæ‰€ä»¥å®ƒä»¬çš„å®ç°ç›¸å¯¹æ¯”è¾ƒç®€å•ã€‚æˆ‘ä»¬åœ¨Mini
CRTä¸­å°†å®ç°ä¸å¦‚æ¸…å•13-4å‡ ä¸ªå­—ç¬¦ä¸²ç›¸å…³çš„æ“ä½œã€‚</p>
<p>æ¸…å•13-4 string.c</p>
<pre><code>char* itoa(int n, char* str, int radix)
{
    char digit[] = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    char* p = str;
    char* head = str;
    if (!p || radix &lt; 2 || radix &gt; 36)
        return p;
    if (radix != 10 &amp;&amp; n &lt; 0)
        return p;
    if (n == 0)
    {
        *p++ = '0';
        *p = 0;
        return p;
    }
    if (radix == 10 &amp;&amp; n &lt; 0)
    {
        *p++ = '-';
        n = -n;
    }
    while (n)
    {
        *p++ = digit[n % radix];
        n /= radix;
    }
    *p = 0;
    
    for (--p; head &lt; p; ++head, --p)
    {
        char temp = *head;
        *head = *p;
        *p = temp;
    }    
    return str;
}

int strcmp (const char * src, const char * dst)
{
    int ret = 0 ;
    unsigned char* p1 = (unsigned char*)src;
    unsigned char* p2 = (unsigned char*)dst;
    while( ! (ret = *p1 - *p2) &amp;&amp; *p2)
        ++p1, ++p2;

    if ( ret &lt; 0 )
    ret = -1 ;
    else if ( ret &gt; 0 )
        ret = 1 ;
    return( ret );
}

char *strcpy(char *dest, const char *src)
{
    char* ret = dest;
    while (*src)
        *dest++ = *src++;
    *dest = '\0';
    return ret;
}

unsigned strlen(const char *str)
{
    int cnt = 0;
    if (!str)
        return 0;
    for (; *str != '\0'; ++str)
        ++cnt;
    return cnt;
}
</code></pre>
<h3 id="1315-æ ¼å¼åŒ–å­—ç¬¦ä¸²"><a class="header" href="#1315-æ ¼å¼åŒ–å­—ç¬¦ä¸²">13.1.5 æ ¼å¼åŒ–å­—ç¬¦ä¸²</a></h3>
<p>ç°åœ¨çš„Mini
CRTå·²ç»åˆå…·é›å½¢äº†ï¼Œå®ƒæ‹¥æœ‰äº†å †ç®¡ç†ã€æ–‡ä»¶æ“ä½œã€åŸºæœ¬å­—ç¬¦ä¸²æ“ä½œã€‚æ¥ä¸‹æ¥å°†è¦å®ç°çš„æ˜¯CRTä¸­ä¸€ä¸ªå¦‚é›·è´¯è€³çš„å‡½æ•°ï¼Œé‚£å°±æ˜¯printfã€‚printfæ˜¯ä¸€ä¸ªå…¸å‹çš„å˜é•¿å‚æ•°å‡½æ•°ï¼Œå³å‚æ•°æ•°é‡ä¸ç¡®å®šï¼Œå¦‚ä½•ä½¿ç”¨å’Œå®ç°å˜é•¿å‚æ•°çš„å‡½æ•°åœ¨ç¬¬10ç« ä¸­å·²ä»‹ç»è¿‡ã€‚ä¸å‰é¢ä¸€æ ·ï¼Œæˆ‘ä»¬å°†è¿™ä¸€èŠ‚è¦å®ç°çš„ç›¸å…³å†…å®¹åˆ—ä¸¾å¦‚ä¸‹ã€‚</p>
<ul>
<li>printfå®ç°ä»…æ”¯æŒ%dã€%sï¼Œä¸”ä¸æ”¯æŒæ ¼å¼æ§åˆ¶ï¼ˆæ¯”å¦‚%08dï¼‰ã€‚</li>
<li>å®ç°fprintfå’Œvfprintfï¼Œå®é™…ä¸Šprintfæ˜¯fprintfçš„ç‰¹æ®Šå½¢å¼ï¼Œå³ç›®æ ‡æ–‡ä»¶ä¸ºæ ‡å‡†è¾“å‡ºçš„fprintfã€‚</li>
<li>å®ç°ä¸æ–‡ä»¶å­—ç¬¦ä¸²æ“ä½œç›¸å…³çš„å‡ ä¸ªå‡½æ•°ï¼Œfputcå’Œfputsã€‚</li>
</ul>
<p>printfç›¸å…³çš„å®ç°ä»£ç å¦‚æ¸…å•13-5æ‰€ç¤ºã€‚</p>
<p>æ¸…å•13-5</p>
<pre><code>#include "minicrt.h"

int fputc(int c,FILE *stream )
{
    if (fwrite(&amp;c, 1, 1, stream) != 1)
        return EOF;
    else
        return c;
}
int fputs( const char *str, FILE *stream)
{
    int len = strlen(str);
    if (fwrite(str, 1, len, stream) != len)
        return EOF;
    else
        return len;
}

#ifndef WIN32
#define va_list char*
#define va_start(ap,arg) (ap=(va_list)&amp;arg+sizeof(arg))
#define va_arg(ap,t) (*(t*)((ap+=sizeof(t))-sizeof(t)))
#define va_end(ap) (ap=(va_list)0)
#else
#include &lt;Windows.h&gt;
#endif

int vfprintf(FILE *stream, const char *format, va_list arglist)
{
    int translating = 0;
    int ret = 0;
    const char* p = 0;
    for (p = format; *p != '\0'; ++p)
    {
        switch (*p)
        {
        case '%':
            if (!translating)
                translating = 1;
            else
            {
                if (fputc('%', stream) &lt; 0)
                    return EOF;
                ++ret;
                translating = 0;
            }
            break;
        case 'd':
            if (translating)    //%d
            {
                char buf[16];
                translating = 0;
                itoa(va_arg(arglist, int), buf, 10);
                if (fputs(buf, stream) &lt; 0)
                    return EOF;
                ret += strlen(buf);
            }
            else if (fputc('d', stream) &lt; 0)
                return EOF;
            else
                ++ret;
            break;
        case 's':
            if (translating)    //%s
            {
                const char* str = va_arg(arglist, const char*);
                translating = 0;
                if (fputs(str, stream) &lt; 0)
                    return EOF;
                ret += strlen(str);
            }
            else if (fputc('s', stream) &lt; 0)
                    return EOF;
            else
                ++ret;
            break;
        default:
            if (translating)
                translating = 0;
            if (fputc(*p, stream) &lt; 0)
                return EOF;
            else
                ++ret;
            break;
        }
    }
    return ret;
}

int printf (const char *format, ...)
{
    va_list(arglist);
    va_start(arglist, format);
    return vfprintf(stdout, format, arglist);
}

int fprintf (FILE *stream, const char *format, ...) 
{
    va_list(arglist);
    va_start(arglist, format);
    return vfprintf(stream, format, arglist);
}
</code></pre>
<p>å¯ä»¥çœ‹åˆ°vfprintfæ˜¯è¿™äº›å‡½æ•°ä¸­çœŸæ­£å®ç°å­—ç¬¦ä¸²æ ¼å¼åŒ–çš„å‡½æ•°ï¼Œå®ç°å®ƒçš„ä¸»è¦å¤æ‚æ€§æ¥æºäºå¯¹æ ¼å¼åŒ–å­—ç¬¦ä¸²çš„åˆ†æã€‚åœ¨è¿™é‡Œä½¿ç”¨äº†ä¸€ç§ç®€å•çš„ç®—æ³•ï¼š</p>
<pre><code>ï¼ˆ1ï¼‰å®šä¹‰æ¨¡å¼ï¼šç¿»è¯‘æ¨¡å¼/æ™®é€šæ¨¡å¼ã€‚
ï¼ˆ2ï¼‰å¾ªç¯æ•´ä¸ªæ ¼å¼å­—ç¬¦ä¸²ã€‚
    a) å¦‚æœé‡åˆ°%ã€‚
        i. æ™®é€šæ¨¡å¼ï¼šè¿›å…¥ç¿»è¯‘æ¨¡å¼ï¼›
        ii. ç¿»è¯‘æ¨¡å¼ï¼šè¾“å‡º%ï¼Œé€€å‡ºç¿»è¯‘æ¨¡å¼ã€‚
    b) å¦‚æœé‡åˆ°%åé¢å…è®¸å‡ºç°çš„ç‰¹æ®Šå­—ç¬¦ï¼ˆå¦‚då’Œsï¼‰ã€‚
        i. ç¿»è¯‘æ¨¡å¼ï¼šä»ä¸å®šå‚æ•°ä¸­å–å‡ºä¸€ä¸ªå‚æ•°è¾“å‡ºï¼Œé€€å‡ºç¿»è¯‘æ¨¡å¼ï¼›
        ii. æ™®é€šæ¨¡å¼ï¼šç›´æ¥è¾“å‡ºè¯¥å­—ç¬¦ã€‚
    c) å¦‚æœé‡åˆ°å…¶ä»–å­—ç¬¦ï¼šæ— æ¡ä»¶é€€å‡ºç¿»è¯‘æ¨¡å¼å¹¶è¾“å‡ºå­—ç¬¦ã€‚
</code></pre>
<p>åœ¨Mini
CRTçš„vfprintfå®ç°ä¸­ï¼Œå¹¶ä¸æ”¯æŒç‰¹æ®Šçš„æ ¼å¼æ§åˆ¶ç¬¦ï¼Œä¾‹å¦‚ä½æ•°ã€è¿›åº¦æ§åˆ¶ç­‰ï¼Œä»…æ”¯æŒ%dä¸%sè¿™æ ·çš„ç®€å•è½¬æ¢ã€‚çœŸæ­£çš„vfprintfæ ¼å¼åŒ–å­—ç¬¦ä¸²å®ç°æ¯”è¾ƒå¤æ‚ï¼Œå› ä¸ºå®ƒæ”¯æŒè¯¸å¦‚"%f"ã€"%x"å·²æœ‰å„ç§æ ¼å¼ã€ä½æ•°ã€ç²¾åº¦æ§åˆ¶ç­‰ï¼Œåœ¨è¿™é‡Œå¹¶æ²¡æœ‰å°†å®ƒä»¬ä¸€ä¸€å®ç°ï¼Œä¹Ÿæ²¡æœ‰è¿™ä¸ªå¿…è¦ï¼ŒMini
CRTçš„printfå·²ç»èƒ½å¤Ÿå……åˆ†å±•ç¤ºprintfçš„å®ç°åŸç†å’Œå®ƒçš„å…³é”®æŠ€å·§ï¼Œè¯»è€…ä¹Ÿå¯ä»¥æ ¹æ®Mini
CRT printfçš„å®ç°å»æ›´åŠ æ·±å…¥åœ°åˆ†æGlibcæˆ–MSVC CRTçš„ç›¸å…³ä»£ç ã€‚</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="chapter_13.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="chapter_13_2.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="chapter_13.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="chapter_13_2.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
